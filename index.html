<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web CRUD Admin</title>
  <style>
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 6px; }
    th { cursor: pointer; background: #f0f0f0; }
    .admin-only { display: none; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <hr/>

  <div id="main" style="display:none;">
    <h2>Data Pelanggan</h2>
    <button onclick="logout()">Logout</button>
    <button class="admin-only" onclick="showPasswordChanger()">Ganti Password</button>
    <div id="passwordChanger" style="display:none">
      <h3>Ganti Password User</h3>
      <input id="targetUser" placeholder="Username">
      <input id="newPassword" type="password" placeholder="Password baru">
      <button onclick="changePassword()">Ganti</button>
    </div>

    <table id="dataTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwrybL4k1v7f5iaUzhgE7uyrYyI6WOLZSXYrvVnqum6PDVIQHYwhA6q4WsIfvgwYUqL/exec";
let data = [], userRole = '', userName = '';
let currentSort = { column: '', asc: true };

async function login() {
  const uname = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const res = await fetch(`${apiUrl}?action=login&username=${uname}&password=${pass}`);
  const json = await res.json();

  if (json.status === 'ok') {
    userRole = json.role;
    userName = uname;
    document.getElementById('main').style.display = 'block';
    document.querySelector('h2').textContent = `Selamat datang, ${uname} (${userRole})`;
    if (userRole === 'admin') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
    loadData();
  } else {
    alert('Login gagal');
  }
}

function logout() {
  location.reload();
}

function showPasswordChanger() {
  document.getElementById('passwordChanger').style.display = 'block';
}

async function changePassword() {
  const uname = document.getElementById('targetUser').value.trim();
  const pass = document.getElementById('newPassword').value.trim();
  if (!uname || !pass) return alert('Lengkapi isian');

  const res = await fetch(apiUrl, {
    method: 'POST',
    body: JSON.stringify({ method: 'CHANGE_PASSWORD', username: uname, password: pass })
  });
  alert(await res.text());
}

async function loadData() {
  const res = await fetch(apiUrl);
  data = await res.json();
  renderTable();
}

function sortTableBy(column) {
  const col = column.toLowerCase().replace(/ /g, '_');
  const asc = (currentSort.column !== col) ? true : !currentSort.asc;
  currentSort = { column: col, asc };
  data.sort((a, b) => a[col] > b[col] ? (asc ? 1 : -1) : (a[col] < b[col] ? (asc ? -1 : 1) : 0));
  renderTable();
}

function renderTable() {
  const head = document.getElementById('tableHead');
  const body = document.getElementById('tableBody');
  head.innerHTML = '';
  body.innerHTML = '';

  if (!data.length) return;
  const headers = Object.keys(data[0]);
  const tr = document.createElement('tr');
  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h.replace(/_/g, ' ').toUpperCase();
    th.onclick = () => sortTableBy(h);
    tr.appendChild(th);
  });
  head.appendChild(tr);

  data.forEach(row => {
    const tr = document.createElement('tr');
    headers.forEach(h => {
      const td = document.createElement('td');
      if (h.startsWith('foto') && row[h]) {
        td.innerHTML = `<img src="https://drive.google.com/uc?export=view&id=${row[h]}" width="100"/>`;
      } else if (h.startsWith('video') && row[h]) {
        td.innerHTML = `<video width="160" controls><source src="https://drive.google.com/uc?export=view&id=${row[h]}" type="video/mp4"></video>`;
      } else {
        td.textContent = row[h];
      }
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}
</script>
</body>
</html>
