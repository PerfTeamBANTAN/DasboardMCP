<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard MCP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            soft: '#f3f4f6',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-soft font-sans">

<!-- Login Area -->
<div id="loginBox" class="flex items-center justify-center min-h-screen px-4">
  <div class="bg-white shadow-xl rounded-xl p-8 w-full max-w-md">
    <h2 class="text-3xl font-bold text-center text-primary mb-6">Login Admin</h2>
    <div class="space-y-4">
      <input id="username" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Username">
      <input id="password" type="password" class="w-full border border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Password">
      <button onclick="login()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-700 transition font-semibold">Login</button>
    </div>
    <p id="loginStatus" class="text-sm text-center text-red-500 mt-4 hidden">Login gagal. Coba lagi.</p>
  </div>
</div>

<!-- App Area -->
<div id="app" class="hidden min-h-screen">
  <!-- Navbar -->
  <nav class="bg-white shadow-md px-6 py-4 flex justify-between items-center sticky top-0 z-50">
    <h1 class="text-xl font-bold text-primary">ðŸ“Š Dashboard MCP</h1>
    <div class="flex gap-4 text-sm font-medium">
      <button onclick="toggleData()" class="hover:text-primary transition">Data</button>
      <button onclick="showPasswordChanger()" class="admin-only hidden hover:text-primary transition">Ganti Password</button>
      <button onclick="logout()" class="text-red-500 hover:text-red-600">Logout</button>
    </div>
  </nav>

  <!-- Welcome Message -->
  <div class="px-6 mt-4">
    <h2 id="welcomeText" class="text-lg font-semibold text-gray-700"></h2>
  </div>

  <!-- Password Change Section -->
  <div id="passwordChanger" class="hidden px-6 mt-6">
    <div class="bg-white p-4 rounded-md shadow">
      <h3 class="font-semibold mb-2 text-gray-700">Ganti Password</h3>
      <div class="flex gap-2 flex-wrap">
        <input id="targetUser" class="border px-4 py-2 rounded w-48" placeholder="Username">
        <input id="newPassword" type="password" class="border px-4 py-2 rounded w-48" placeholder="Password Baru">
        <button onclick="changePassword()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ganti</button>
      </div>
    </div>
  </div>

  <!-- Data Table Section -->
  <div id="dataSection" class="hidden px-6 py-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">ðŸ“‹ Data Pelanggan</h2>
    <div class="overflow-x-auto bg-white rounded-lg shadow">
      <table class="min-w-full text-sm text-left border">
        <thead class="bg-primary text-white">
          <tr>
            <th class="p-2">ID</th><th class="p-2">NAMA</th><th class="p-2">EMAIL</th><th class="p-2">HP1</th><th class="p-2">HP2</th>
            <th class="p-2">WA</th><th class="p-2">ALAMAT</th><th class="p-2">LOKASI</th><th class="p-2">KET. ALAMAT</th><th class="p-2">JANJI</th>
            <th class="p-2">SALES</th><th class="p-2">TL</th>
            <th class="p-2">F1</th><th class="p-2">F2</th><th class="p-2">F3</th><th class="p-2">F4</th><th class="p-2">F5</th>
            <th class="p-2">V1</th><th class="p-2">V2</th>
            <th class="p-2 admin-only hd-only">Action</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-white divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbwrybL4k1v7f5iaUzhgE7uyrYyI6WOLZSXYrvVnqum6PDVIQHYwhA6q4WsIfvgwYUqL/exec";
let data = [], userRole = '', userName = '';

function login() {
  const uname = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  document.getElementById('loginStatus').classList.add('hidden');

  fetch(`${apiUrl}?action=login&username=${uname}&password=${pass}`)
    .then(res => res.json())
    .then(json => {
      if (json.status === 'ok') {
        userRole = json.role;
        userName = uname;
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('welcomeText').textContent = `Selamat datang, ${uname} (${userRole})`;
        if (userRole === 'admin' || userRole === 'hd') {
          document.querySelectorAll('.admin-only, .hd-only').forEach(e => e.classList.remove('hidden'));
        }
        loadData();
      } else {
        document.getElementById('loginStatus').classList.remove('hidden');
      }
    })
    .catch(err => {
      alert("Gagal koneksi ke server.");
      console.error(err);
    });
}

function logout() { location.reload(); }
function showPasswordChanger() {
  document.getElementById('passwordChanger').classList.toggle('hidden');
}
function toggleData() {
  const section = document.getElementById('dataSection');
  section.classList.toggle('hidden');
  if (!section.classList.contains('hidden')) renderTable();
}

function loadData() {
  fetch(apiUrl)
    .then(res => res.json())
    .then(json => { data = json; });
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  const keys = ["id","nama","email","hp1","hp2","wa_di_hp","alamat","lokasi","keterangan_alamat","janji_aktivasi","sales","tl_sales","foto1","foto2","foto3","foto4","foto5","video1","video2"];
  data.forEach(row => {
    const tr = document.createElement('tr');
    keys.forEach(k => {
      const td = document.createElement('td');
      td.className = 'p-2';
      if (k.startsWith('foto') && row[k]) {
        td.innerHTML = `<img src="https://drive.google.com/uc?export=view&id=${row[k]}" class="w-20 rounded">`;
      } else if (k.startsWith('video') && row[k]) {
        td.innerHTML = `<video class="w-32 rounded" controls><source src="https://drive.google.com/uc?export=view&id=${row[k]}" type="video/mp4"></video>`;
      } else {
        td.textContent = row[k] || '';
      }
      tr.appendChild(td);
    });
    if (userRole === 'admin' || userRole === 'hd') {
      const tdEdit = document.createElement('td');
      tdEdit.innerHTML = `<button class="text-indigo-600 hover:underline" onclick='alert("Edit belum tersedia")'>Edit</button>`;
      tr.appendChild(tdEdit);
    }
    tbody.appendChild(tr);
  });
}

function changePassword() {
  const uname = document.getElementById('targetUser').value.trim();
  const pass = document.getElementById('newPassword').value.trim();
  if (!uname || !pass) return alert('Lengkapi semua isian!');
  fetch(apiUrl, {
    method: 'POST',
    body: JSON.stringify({ method: 'CHANGE_PASSWORD', username: uname, password: pass })
  }).then(res => res.text()).then(alert);
}
</script>
</body>
</html>
